# Performance benchmarking workflow
# Runs weekly to track performance over time
on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'powerNMA/R/**'
      - 'powerNMA/tests/benchmark/**'

name: Benchmark

jobs:
  benchmark:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: powerNMA
          extra-packages: any::bench, any::ggplot2, any::microbenchmark

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Run benchmarks
        run: |
          # Create benchmark directory if it doesn't exist
          dir.create("powerNMA/tests/benchmark", showWarnings = FALSE, recursive = TRUE)

          # Run performance benchmarks
          if (file.exists("powerNMA/tests/benchmark/run_benchmarks.R")) {
            source("powerNMA/tests/benchmark/run_benchmarks.R")
          } else {
            cat("No benchmark script found. Creating basic benchmark...\n")

            # Basic benchmark example
            library(microbenchmark)

            # Benchmark simulate_nma_data
            if (requireNamespace("powerNMA", quietly = TRUE)) {
              bench_results <- microbenchmark(
                small = powerNMA::simulate_nma_data(n_studies = 10),
                medium = powerNMA::simulate_nma_data(n_studies = 50),
                large = powerNMA::simulate_nma_data(n_studies = 100),
                times = 10
              )

              print(bench_results)
              saveRDS(bench_results, "powerNMA/tests/benchmark/benchmark_results.rds")
            }
          }
        shell: Rscript {0}

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: powerNMA/tests/benchmark/
          retention-days: 90

      - name: Comment on commit (if push)
        if: github.event_name == 'push'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ“Š Performance Benchmark Results\n\n';
            comment += 'Benchmark completed successfully.\n\n';
            comment += 'Download artifacts to view detailed results.';

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
